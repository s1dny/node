# Homelab Setup Guide

This stack gives you:
- NixOS on bare metal (Dell Optiplex 7060)
- k3s for orchestration
- Cloudflare Tunnel for inbound traffic (`db`, `photos`, `kopia`, `vault`)
- Cloudflare Access policies for `photos` and `kopia`
- `libsql` in k3s at `https://db.aza.network`
- Immich in k3s at `https://photos.aza.network`
- Vaultwarden in k3s at `https://vault.aza.network`
- Kopia local encrypted repository on the Optiplex, replicated to Cloudflare R2
- MacBook backups to Optiplex via Kopia Repository Server through Cloudflare Access

## 0) Prerequisites
- Domain in Cloudflare: `aza.network`
- Cloudflare Zero Trust account (`<team>.cloudflareaccess.com`)
- A dashboard-managed Cloudflare Tunnel token
- NixOS installer USB
- LAN static IP reservation for Optiplex recommended
- Console/KVM access for first boot (SSH key auth is enforced)

## 1) Install NixOS (fresh machine)
1. Boot NixOS installer.
2. Run `disko` partitioning (this will erase the target disk):
   ```bash
   sudo -i
   lsblk -d -o NAME,SIZE,MODEL,SERIAL
   ls -l /dev/disk/by-id
   # Strongly recommended: set disko.devices.disk.main.device to a stable /dev/disk/by-id/... path.
   # Double-check it is your target SSD/NVMe and not the installer USB.
   # Put this repo on the installer at /root/homelab (example):
   # git clone <YOUR_REPO_URL> /root/homelab
   cd /root/homelab
   # Then edit nixos/disko.nix and set disko.devices.disk.main.device.
   nix --extra-experimental-features "nix-command flakes" run github:nix-community/disko/latest -- --mode disko nixos/disko.nix
   nixos-generate-config --root /mnt
   ```
3. Copy this project into the target system root:
   ```bash
   mkdir -p /mnt/etc/nixos/homelab
   cp -a /root/homelab/. /mnt/etc/nixos/homelab/
   ```
4. Use this project's NixOS config as the active install config:
   ```bash
   cp /mnt/etc/nixos/homelab/nixos/configuration.nix /mnt/etc/nixos/configuration.nix
   ```
   Keep `/mnt/etc/nixos/hardware-configuration.nix` as generated by `nixos-generate-config`.
5. Install:
   ```bash
   nixos-install
   reboot
   ```

## 2) Host config edits you must make
Before first `nixos-rebuild`, edit `/etc/nixos/configuration.nix`:
```bash
sudoedit /etc/nixos/configuration.nix
```
- Replace `users.users.homelab.openssh.authorizedKeys.keys` with your own SSH public key.
  This is required because root SSH login is disabled and SSH password auth is disabled.

Pre-set defaults you may optionally change include hostname/timezone, fish as default shell, and fish aliases:
- `cd` -> `z` (zoxide)
- `v` -> `nvim`
- `ls` -> `eza`
- Immich app timezone in `k8s/04-immich-values.yaml` is `Australia/Sydney` (change it to match your locale if needed)

Create Cloudflare tunnel token env file:
```bash
sudo install -d -m 0700 /etc/cloudflared
sudo cp /etc/nixos/homelab/cloudflare/tunnel-token.env.example /etc/cloudflared/tunnel-token.env
sudoedit /etc/cloudflared/tunnel-token.env
# put exactly one line:
# CLOUDFLARE_TUNNEL_TOKEN=PASTE_YOUR_TOKEN_HERE
sudo chmod 0600 /etc/cloudflared/tunnel-token.env
```

Then apply config:
```bash
sudo nixos-rebuild switch
```

## 3) Cloudflare Tunnel + DNS
In Cloudflare Zero Trust dashboard:
1. Go to `Networks` -> `Tunnels` -> `Create a tunnel` -> `Cloudflared`.
2. Name it `azalab-0`.
3. In `Public hostnames`, add:
   - `db.aza.network` -> `http://localhost:80`
   - `photos.aza.network` -> `http://localhost:80`
   - `kopia.aza.network` -> `http://localhost:80`
   - `vault.aza.network` -> `http://localhost:80`
4. Save tunnel and copy the install token.
5. Put that token in `/etc/cloudflared/tunnel-token.env`, then restart cloudflared:
   ```bash
   sudo systemctl restart cloudflared-dashboard-tunnel
   sudo systemctl status cloudflared-dashboard-tunnel --no-pager
   ```

`cloudflare/local-managed-tunnel-config.example.yaml` is only for locally-managed tunnel mode and is not used in this dashboard-token setup.

## 4) Deploy Kubernetes workloads
1. Copy this repo to `/etc/nixos/homelab` on the Optiplex (if it is not already there from install).
2. Create real secrets from the examples in `k8s/secrets/*.example.yaml`:
   ```bash
   cd /etc/nixos/homelab
   cp k8s/secrets/libsql-auth.example.yaml k8s/secrets/libsql-auth.yaml
   cp k8s/secrets/kopia-auth.example.yaml k8s/secrets/kopia-auth.yaml
   cp k8s/secrets/immich-db-secret.example.yaml k8s/secrets/immich-db-secret.yaml
   cp k8s/secrets/immich-redis-secret.example.yaml k8s/secrets/immich-redis-secret.yaml
   cp k8s/secrets/vaultwarden-secret.example.yaml k8s/secrets/vaultwarden-secret.yaml
   ```
   Then edit the copied `*.yaml` files and replace all placeholder values.
   Quick check before deploy:
   ```bash
   grep -nE "REPLACE_WITH|REPLACE_ME|CHANGE_ME" k8s/secrets/*.yaml || true
   ```
   Expected: no output.
3. Configure `kubectl`/`helm` access for your user:
   ```bash
   mkdir -p ~/.kube
   sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
   sudo chown "$USER":"$(id -gn)" ~/.kube/config
   chmod 600 ~/.kube/config
   ```
4. Confirm k3s is healthy:
   ```bash
   sudo systemctl status k3s --no-pager
   kubectl get nodes
   ```
5. Deploy everything (recommended):
   ```bash
   cd /etc/nixos/homelab
   ./scripts/deploy-k8s.sh
   ```
   This applies namespaces/PVs/secrets/workloads and installs Immich.
   Optional version overrides:
   ```bash
   IMMICH_CHART_VERSION=0.9.3 IMMICH_APP_VERSION=v1.136.0 ./scripts/deploy-k8s.sh
   ```
   Note: `k8s/02-libsql.yaml`, `k8s/03-kopia.yaml`, and `k8s/05-vaultwarden.yaml` currently use `:latest` container tags.
   Pin explicit image versions for repeatable upgrades.

## 5) Cloudflare Access policies (edge auth)
Create two Access applications in Zero Trust dashboard:
- App 1: `photos.aza.network`
- App 2: `kopia.aza.network`

Policy recommendation:
- `Allow` only your identity provider group/emails.
- Add device posture requirements if you use WARP on trusted devices.

Do not put `vault.aza.network` behind Cloudflare Access if you want to use native Bitwarden clients.
Use Vaultwarden authentication + 2FA instead.

No NixOS `audTag` placeholders are needed with dashboard-managed tunnel mode.

## 6) Vaultwarden first account + hardening
After deploy completes:
1. Open `https://vault.aza.network` and create your first account.
2. Open `https://vault.aza.network/admin` and sign in with `ADMIN_TOKEN` from `k8s/secrets/vaultwarden-secret.yaml`.
3. Disable public registrations:
   - edit `k8s/05-vaultwarden.yaml`
   - change `SIGNUPS_ALLOWED` from `"true"` to `"false"`
   - apply it:
   ```bash
   kubectl apply -f /etc/nixos/homelab/k8s/05-vaultwarden.yaml
   ```

## 7) Kopia: local encrypted repo + R2 replication
Create host env file:
```bash
sudo install -d -m 0700 /etc/kopia
sudo cp /etc/nixos/homelab/scripts/kopia.env.example /etc/kopia/kopia.env
sudo chmod 0600 /etc/kopia/kopia.env
sudoedit /etc/kopia/kopia.env
```
Required values:
- `KOPIA_REPOSITORY_PASSWORD` (must match `KOPIA_REPOSITORY_PASSWORD` in `k8s/secrets/kopia-auth.yaml`)
- `KOPIA_R2_ACCESS_KEY_ID`
- `KOPIA_R2_SECRET_ACCESS_KEY`
- `KOPIA_R2_BUCKET`
- `KOPIA_R2_ENDPOINT` (format: `https://<accountid>.r2.cloudflarestorage.com`)

Security note:
- `k8s/03-kopia.yaml` runs Kopia server with `--insecure` and `--disable-csrf-token-checks`.
- Keep `kopia.aza.network` protected by Cloudflare Access and do not expose the service directly.

Enable timers:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now kopia-host-backup.timer
sudo systemctl enable --now kopia-r2-sync.timer
```

Run once immediately:
```bash
sudo systemctl start kopia-host-backup.service
sudo systemctl start kopia-r2-sync.service
```

## 8) MacBook backup to Optiplex (through Access)
On macOS:
```bash
brew install cloudflared kopia
```

Start authenticated local tunnel:
```bash
cloudflared access tcp --hostname kopia.aza.network --url localhost:15151
```

In another terminal, connect Kopia client to local proxy:
```bash
kopia repository connect server \
  --url=http://127.0.0.1:15151 \
  --override-hostname=kopia.aza.network \
  --server-username=<KOPIA_SERVER_USERNAME> \
  --server-password=<KOPIA_SERVER_PASSWORD>
```
Use the same `KOPIA_SERVER_USERNAME`/`KOPIA_SERVER_PASSWORD` values configured in `k8s/secrets/kopia-auth.yaml`.

Create snapshots:
```bash
kopia snapshot create ~/Documents ~/Pictures ~/Desktop
```
Optional helpers from this repo:
```bash
./macbook/connect-kopia-through-access.sh
KOPIA_SERVER_USERNAME=... KOPIA_SERVER_PASSWORD=... ./macbook/backup-macbook.sh
```

## 9) Verification checklist
```bash
sudo systemctl status cloudflared-dashboard-tunnel --no-pager
kubectl get pods -A
kubectl -n libsql get ingress,svc,pods
kubectl -n immich get ingress,svc,pods
kubectl -n backup get ingress,svc,pods
kubectl -n vaultwarden get ingress,svc,pods
```

Backup checks:
```bash
sudo journalctl -u kopia-host-backup.service -n 100 --no-pager
sudo journalctl -u kopia-r2-sync.service -n 100 --no-pager
```
