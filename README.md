# Homelab NixOS Setup

Personal homelab configuration for a Dell Optiplex 7060 running NixOS with k3s. Defaults are hardcoded to my setup (domain, hostnames, SSH keys, etc.). If you want to change the defaults, fork the repo and edit them there.

## What's running
- NixOS on bare metal
- k3s for orchestration
- Docker (enabled declaratively by the homelab module)
- Cloudflare Tunnels
- Kopia backup server at `https://kopia.aza.network`, replicated to Cloudflare R2
- MacBook backups to Optiplex via Kopia + Cloudflare Access

## Architecture
Clone-free on the host, reproducible by lock file:
- `/etc/nixos/flake.nix`: host bootstrap flake
- `/etc/nixos/flake.lock`: pinned revisions for `nixpkgs` and this repo
- `/etc/homelab/source`: read-only symlink to the pinned source
- `/etc/homelab/source/flux/clusters/<cluster>/manifests/apps/<app>/`: app manifests
- `/etc/homelab/source/flux/clusters/<cluster>/`: Flux cluster reconciliation entrypoint
- `/etc/homelab/source/nixos/secrets/host-secrets.sops.yaml`: encrypted host secrets (SOPS)
- `/etc/homelab/source/flux/clusters/<cluster>/manifests/apps/secrets.sops.yaml`: encrypted Kubernetes Secret manifests (SOPS)
- `/var/lib/sops-nix/key.txt`: age private key used by `sops-nix` for host secret decryption
- `/run/secrets/homelab/*.env`: runtime secret files generated by `sops-nix`
- `flux-system/sops-age`: Kubernetes Secret used by Flux for SOPS decryption

## Prerequisites
- Domain in Cloudflare: `aza.network`
- Cloudflare Zero Trust account
- Dashboard-managed Cloudflare Tunnel token
- NixOS installer USB
- Console/KVM access for first boot (SSH key auth is enforced)

## 1) Install NixOS (fresh machine)
1. Boot NixOS installer. Make sure you have network (Ethernet should auto-connect).
2. Partition using `disko` (this erases the target disk):
   ```bash
   sudo -i
   lsblk -d -o NAME,SIZE,MODEL,SERIAL

   curl -fsSL "https://raw.githubusercontent.com/s1dny/node/main/nixos/disko.nix" -o /tmp/disko.nix
   # edit and set disko.devices.disk.main.device to your disk
   vi /tmp/disko.nix

   nix --extra-experimental-features "nix-command flakes" run github:nix-community/disko/latest -- --mode disko /tmp/disko.nix
   nixos-generate-config --root /mnt
   ```
3. Fetch host bootstrap flake and generate lock file:
   ```bash
   mkdir -p /mnt/etc/nixos
   cd /mnt/etc/nixos
   curl -fsSL "https://raw.githubusercontent.com/s1dny/node/main/nixos/flake.nix" -o flake.nix
   # if this host is not azalab-0, edit flake.nix and set both:
   # - nixosConfigurations.<cluster>
   # - networking.hostName = "<cluster>";
   vi flake.nix
   nix --extra-experimental-features "nix-command flakes" flake lock
   ```
4. Install and reboot:
   ```bash
   CLUSTER=azalab-0
   # set CLUSTER to this host name, e.g. azalab-1 or azalab-2
   nixos-install --flake /mnt/etc/nixos#${CLUSTER}
   sudo passwd aiden
   reboot
   ```
5. After reboot, find the machine's IP (check your router or run `ip a` on the console). If `sudo` works in your current console session
   ```bash
   ssh aiden@azalab-0
   ```
   Do everything from here on over SSH.
   Server-side commands below use `$(hostname -s)` so you don't need to manually export `CLUSTER`.
6. On the server, rebuild once to let `sops-nix` create the persistent age key automatically:
   ```bash
   sudo nixos-rebuild switch --flake /etc/nixos#$(hostname -s)
   ```
7. From your local machine, install the same key for `sops edit` (one-time):
   ```bash
   mkdir -p ~/.config/sops/age
   ssh aiden@azalab-0 'sudo cat /var/lib/sops-nix/key.txt' > ~/.config/sops/age/keys.txt
   chmod 600 ~/.config/sops/age/keys.txt
   ```

8. Edit encrypted secrets, then commit/push:
   ```bash
   # install once (pick one)
   # macOS: brew install sops age
   # Nix: nix shell nixpkgs#sops nixpkgs#age

   sops edit nixos/secrets/host-secrets.sops.yaml
   sops edit flux/clusters/azalab-0/manifests/apps/secrets.sops.yaml

   git add .sops.yaml nixos/secrets/host-secrets.sops.yaml flux/clusters/azalab-0/manifests/apps/secrets.sops.yaml
   git commit -m "Update homelab secrets"
   git push
   ```

## 2) Day-2 updates
```bash
cd /etc/nixos
sudo nix flake update homelab
sudo nixos-rebuild switch --flake /etc/nixos#$(hostname -s)
```

`/etc/nixos/flake.lock` is the exact deployed source-of-truth.

## 3) Cloudflare Tunnel
In Cloudflare Zero Trust dashboard, create a tunnel named the same as your cluster (for example `azalab-0`) with these hostnames:
- `db.aza.network` -> `http://localhost:80`
- `photos.aza.network` -> `http://localhost:80`
- `kopia.aza.network` -> `http://localhost:80`
- `vault.aza.network` -> `http://localhost:80`
- `matrix.aza.network` -> `http://localhost:80`

Set `CLOUDFLARE_TUNNEL_TOKEN` in `nixos/secrets/host-secrets.sops.yaml` (`cloudflare_tunnel_token_env`) and rebuild.

## 4) Bootstrap Flux and reconcile workloads
Run this once per cluster (safe to rerun).
```bash
CLUSTER="${CLUSTER:-$(hostname -s)}"
kubectl get nodes
kubectl apply -f https://github.com/fluxcd/flux2/releases/download/v2.6.4/install.yaml
kubectl -n flux-system rollout status deployment/source-controller --timeout=5m
kubectl -n flux-system rollout status deployment/kustomize-controller --timeout=5m
kubectl -n flux-system rollout status deployment/helm-controller --timeout=5m

kubectl apply -f /etc/homelab/source/flux/clusters/${CLUSTER}/manifests/cluster/namespaces.yaml
sudo systemctl start homelab-ensure-flux-sops-age.service
kubectl -n flux-system get secret sops-age

kubectl apply -f /etc/homelab/source/flux/clusters/${CLUSTER}/flux-system-sync.yaml
kubectl -n flux-system wait --for=condition=Ready=True kustomization/flux-system --timeout=5m
kubectl -n flux-system wait --for=condition=Ready=True kustomization/infrastructure --timeout=10m
kubectl -n flux-system wait --for=condition=Ready=True kustomization/apps --timeout=10m
homelab-check-k8s-health
```

If you have not configured Kopia yet, `backup/kopia-repository-server` may stay unhealthy and keep `kustomization/apps` in `Progressing`.

If you fork this repo, update `flux/clusters/<cluster>/flux-system-sync.yaml` so `spec.url` and `spec.ref.branch` point at your Git remote and branch.

## 5) Cloudflare Access policies
Put `photos.aza.network` and `kopia.aza.network` behind Cloudflare Access. Don't put `vault.aza.network` behind it if you need native Bitwarden clients.

## 6) Vaultwarden setup
1. Create first account at `https://vault.aza.network`.
2. Sign into admin at `https://vault.aza.network/admin` using:
   ```bash
   kubectl -n vaultwarden get secret vaultwarden-secret -o jsonpath='{.data.ADMIN_TOKEN}' | base64 -d; echo
   ```
3. Disable public registrations:
   ```bash
   kubectl -n vaultwarden set env deployment/vaultwarden SIGNUPS_ALLOWED="false"
   ```
   Then commit the same change to `flux/clusters/<cluster>/manifests/apps/vaultwarden/manifest.yaml` in Git so it persists across rebuilds.

## 7) Kopia backups
`flux/clusters/<cluster>/manifests/apps/kopia/manifest.yaml` uses `--insecure` and `--disable-csrf-token-checks`. Keep `kopia.aza.network` behind Cloudflare Access.

`KOPIA_R2_ENDPOINT` format: `https://<accountid>.r2.cloudflarestorage.com`

Timers run automatically (`kopia-host-backup.timer`, `kopia-r2-sync.timer`). Run manually if needed:
```bash
sudo systemctl start kopia-host-backup.service
sudo systemctl start kopia-r2-sync.service
```

## 8) MacBook backup
```bash
brew install cloudflared kopia
cloudflared access tcp --hostname kopia.aza.network --url localhost:15151
```

In another terminal:
```bash
kopia repository connect server \
  --url=http://127.0.0.1:15151 \
  --override-hostname=kopia.aza.network \
  --server-username=YOUR_USERNAME \
  --server-password=YOUR_PASSWORD

kopia snapshot create ~/Documents ~/Pictures ~/Desktop
```

## 9) Verification
Run the built-in health check first:
```bash
homelab-check-k8s-health
```

Verify Flux and workloads are healthy:
```bash
kubectl -n flux-system get gitrepository flux-system
kubectl -n flux-system get kustomization flux-system infrastructure apps
kubectl -n flux-system get helmreleases -A
kubectl get pods -A
```

## 10) Samba file share
Samba is enabled by the homelab module with:
- Share `srv` (guest write): `/srv`
- Discovery: `wsdd` is enabled for Windows network discovery

Quick check:
```bash
sudo systemctl --no-pager status samba-smbd samba-nmbd samba-wsdd
```